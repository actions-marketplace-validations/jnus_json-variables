name: ci
  
on: [push, workflow_dispatch]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    environment: Dev
    steps:
    - uses: actions/checkout@v2

    # - name: test
    #   shell: pwsh
    #   run: | 
    #     ./test/run.ps1
    
    # - name: print
    #   run: env

    - name: pester tests
      id: pester_tests
      uses: zyborg/pester-tests-report@v1
      with:
        include_paths: test
        # exclude_paths: tests/powershell1,tests/powershell2
        # exclude_tags: skip_ci
        report_name: module_tests
        report_title: My Module Tests
        github_token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: dump test results
      shell: pwsh
      run: |
        Write-Host 'Total Tests Executed...:  ${{ steps.pester_tests.outputs.total_count }}'
        Write-Host 'Total Tests PASSED.....:  ${{ steps.pester_tests.outputs.passed_count }}'
        Write-Host 'Total Tests FAILED.....:  ${{ steps.pester_tests.outputs.failed_count }}'
    
  test-action-minimal-dev:
    needs: unit-test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    environment: Dev
    steps:
    - uses: actions/checkout@v2

    - name: Set environment specific variables
      uses: jnus/json-variables@main
      with:
        scope: Dev
        configFile: 'variables.minimal.json'
        secrets: '${{ toJson(secrets) }}'
    
    - name: Print
      run: env

    - name: Assert
      shell: pwsh
      run: |
        $here = Split-Path $MyInvocation.MyCommand.Definition
        $path = Join-Path -Path ./ -ChildPath 'test'
        $module = Join-Path -Path $path -ChildPath 'Assertion.psm1'
        Import-Module $module -Force
        Assert-EnvVar -actual ${{env.Url}} -expected 'https://someDevHostName.com' -envVar "env.Url"
        Assert-EnvVar -actual ${{env.HostName}} -expected 'someDevHostName' -envVar "env.HostName"
  
  test-action-minimal-devtest:
    needs: unit-test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    environment: DevTest
    steps:
    - uses: actions/checkout@v2

    - name: Set environment specific variables
      uses: jnus/json-variables@main
      with:
        scope: DevTest
        configFile: 'test/variables.minimal.json'
        secrets: '${{ toJson(secrets) }}'   
    
    - name: Print
      run: env

    - name: Assert
      shell: pwsh
      run: |
        $here = Split-Path $MyInvocation.MyCommand.Definition
        $path = Join-Path -Path ./ -ChildPath 'test'
        $module = Join-Path -Path $path -ChildPath 'Assertion.psm1'
        Import-Module $module -Force
        Assert-EnvVar -actual '${{env.Url}}' -expected 'https://someDevTestHostName.com' -envVar "env.Url"
        Assert-EnvVar -actual '${{env.HostName}}' -expected 'someDevTestHostName' -envVar "env.HostName"
        Assert-EnvVar -actual '${{env.SecretA}}' -expected 'repo_secret_a' -envVar "env.SecretA"
        Assert-EnvVar -actual '${{env.ConnectionString}}' -expected 'username=user;password=repo_secret_a' -envVar "env.ConnectionString"
  